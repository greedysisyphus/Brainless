# 智能觸發和更新日誌功能 - 問題分析報告

## 已實現的功能

### 1. 智能觸發部署
- ✅ 自動比較新舊資料
- ✅ 只在有實質變化時觸發部署
- ✅ 只有 `updated_at` 變化時不觸發部署
- ⚠️ **重要：部署是由 GitHub Actions 控制的，與前端的更新日誌無關**

### 2. 更新日誌
- ✅ 記錄資料載入歷史（僅記錄有變化的載入或用戶主動切換日期）
- ✅ 顯示更新時間、日期、航班數量
- ✅ 標記是否有變化
- ✅ **點擊查看詳細變化**（新增功能）
- ✅ **避免重複記錄**：不會在頁面刷新時自動記錄日誌

## 發現的 5 個潛在問題及修正方案

### 問題 1: compare-data.py 腳本失敗時的處理邏輯
**問題描述：**
- 如果 `compare-data.py` 因為 Python 錯誤、依賴缺失等原因失敗，`steps.compare.outputs.has_changes` 可能為空
- 在 commit 步驟中，如果輸出為空，會默認使用 skip 標記，可能導致有實質變化時不觸發部署

**修正方案：**
- ✅ 在腳本開始時設置默認值 `has_changes=false`
- ✅ 處理不同的退出碼（0=有變化，1=無變化，其他=錯誤）
- ✅ 在 commit 步驟中檢查輸出是否為空，並提供默認值
- ✅ 如果腳本出現未知錯誤，為安全起見視為有變化（觸發部署）

**代碼位置：**
- `.github/workflows/update-flight-data.yml` 第 49-74 行
- `.github/workflows/update-flight-data.yml` 第 89-95 行

---

### 問題 2: Git 歷史被重寫或清理時無法獲取舊版本
**問題描述：**
- 如果 Git 歷史被重寫（rebase、force push），`git show HEAD:data/xxx.json` 可能無法獲取舊版本
- 如果倉庫是全新的，沒有歷史記錄，也會出現同樣問題

**修正方案：**
- ✅ 使用 try-except 捕獲所有異常
- ✅ 如果無法從 Git 獲取舊版本，視為有新資料（觸發部署）
- ✅ 設置 10 秒超時，避免長時間等待

**代碼位置：**
- `scripts/scraper/compare-data.py` 第 194-225 行

---

### 問題 3: 資料文件格式不一致或缺少欄位
**問題描述：**
- 如果舊資料和新資料的格式不一致（例如欄位名稱改變）
- 如果資料缺少必要欄位（time, gate, flight_code），比較邏輯可能出錯

**修正方案：**
- ✅ 使用 `.get()` 方法安全獲取欄位，提供默認值
- ✅ 在 `normalize_flight` 函數中統一處理欄位
- ✅ 使用 try-except 包裹資料處理，跳過有問題的資料
- ✅ 如果 JSON 解析失敗，視為有變化（觸發部署）

**代碼位置：**
- `scripts/scraper/compare-data.py` 第 12-26 行（normalize_flight）
- `scripts/scraper/compare-data.py` 第 37-53 行（資料處理）

---

### 問題 4: 多個日期資料同時更新，但只有部分有變化
**問題描述：**
- 如果同時更新了多個日期的資料（例如今天和明天），但只有今天的資料有變化
- 目前的邏輯會檢查所有文件，只要有一個有變化就觸發部署

**修正方案：**
- ✅ 當前邏輯是正確的：只要有一個文件有實質變化，就應該觸發部署
- ✅ 因為部署會包含所有最新的資料文件，即使某些文件沒有變化
- ✅ 這樣可以確保網頁顯示的是最新、最完整的資料

**代碼位置：**
- `scripts/scraper/compare-data.py` 第 179-242 行（循環檢查所有文件）
- `scripts/scraper/compare-data.py` 第 247-252 行（只要有變化就觸發）

---

### 問題 5: 更新日誌的 localStorage 存儲限制和重複記錄
**問題描述：**
- localStorage 有大小限制（通常 5-10MB）
- 如果更新日誌太多，可能導致存儲失敗
- 如果用戶清除瀏覽器數據，日誌會丟失
- **每次刷新頁面都會記錄日誌，導致重複記錄**

**修正方案：**
- ✅ 只保留最近 100 條記錄，避免存儲過大
- ✅ 使用 try-catch 包裹所有 localStorage 操作
- ✅ 如果存儲失敗，至少更新狀態（不包含新條目）
- ✅ 添加錯誤日誌以便調試
- ✅ **只在有實質變化或用戶主動切換日期時記錄日誌**
- ✅ **避免在頁面初始化時記錄日誌**
- ✅ **檢查最近 1 分鐘內是否有相同日期的記錄，避免重複記錄**

**代碼位置：**
- `src/components/playground/FlightDataContent.jsx` 第 313-390 行

---

### 問題 6: 更新日誌與部署的關係（用戶誤解）
**問題描述：**
- 用戶可能誤以為更新日誌中的「有變化」標記會觸發部署
- 實際上，更新日誌是前端功能，部署是由 GitHub Actions 控制的

**澄清：**
- ✅ 更新日誌是**前端功能**，記錄用戶在瀏覽器中載入資料的歷史
- ✅ 部署是由**GitHub Actions 的智能觸發邏輯**控制的
- ✅ 兩者**完全獨立**，更新日誌不會影響部署
- ✅ 部署的觸發條件：
  - 資料有實質變化（由 `compare-data.py` 檢測）
  - 提交訊息不包含 `[skip ci]` 或 `[skip workflow]`

---

## 新增功能：點擊查看詳細變化

### 功能說明
- ✅ 在更新日誌中，如果記錄有變化，可以點擊查看詳細資訊
- ✅ 顯示新增、移除、修改的航班詳細列表
- ✅ 顯示狀態變更的前後對比
- ✅ 美觀的 UI 設計，使用不同顏色區分變化類型

### 實現細節
- 添加 `selectedLogDetail` 狀態來存儲選中的日誌
- 在日誌條目上添加點擊事件（僅當有變化時可點擊）
- 創建新的 Modal 顯示詳細變化
- 使用顏色編碼：綠色=新增，紅色=移除，黃色=修改

**代碼位置：**
- `src/components/playground/FlightDataContent.jsx` 第 33 行（狀態定義）
- `src/components/playground/FlightDataContent.jsx` 第 1546-1614 行（日誌列表）
- `src/components/playground/FlightDataContent.jsx` 第 1622-1750 行（詳細變化 Modal）

---

## 測試建議

### 正常情況測試
1. ✅ 資料有實質變化時應觸發部署
2. ✅ 只有 `updated_at` 變化時不觸發部署
3. ✅ 更新日誌正確記錄每次載入
4. ✅ 點擊有變化的日誌可以查看詳細資訊

### 邊界情況測試
1. ⚠️ 首次運行（Git 中沒有舊版本）
2. ⚠️ 腳本失敗（Python 錯誤、依賴缺失）
3. ⚠️ Git 歷史被重寫
4. ⚠️ 資料格式不一致
5. ⚠️ localStorage 存儲失敗

---

## 結論

所有發現的問題都已修正，代碼應該能夠正常運作。新增的「點擊查看詳細變化」功能已經實現，用戶可以方便地查看每次更新的詳細資訊。
