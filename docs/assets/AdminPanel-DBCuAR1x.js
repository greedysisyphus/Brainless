const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/index-CwwGDm5I.js","assets/index--zunUjs7.css"])))=>i.map(i=>d[i]);
import{j as e,r as m,g as se,c as ze,p as $e,a as te,d as U,b as P,e as Fe,f as Re,v as Se,h as Ee,i as Le,k as Ae,u as qe,l as le,m as Ie,o as Oe,_ as _e,s as Pe,n as We}from"./index-CwwGDm5I.js";const Be=({children:i,className:c="",maxWidth:h="container-custom",padding:p="py-4 sm:py-6 lg:py-8",center:t=!0})=>e.jsx("div",{className:`${h} ${p} ${t?"mx-auto":""} ${c}`,children:i}),Ue=({children:i,className:c="",padding:h="p-4 sm:p-6",hover:p=!0})=>e.jsx("div",{className:`
      bg-surface rounded-xl shadow-lg border border-white/5 
      ${h} 
      ${p?"hover:shadow-xl hover:border-white/10 transition-all duration-200":""} 
      ${c}
    `,children:i}),f=({children:i,onClick:c,variant:h="primary",size:p="md",disabled:t=!1,loading:N=!1,className:b="",...D})=>{const E=()=>{switch(h){case"primary":return"bg-primary text-white hover:bg-primary/80 disabled:bg-primary/50";case"secondary":return"bg-white/10 text-white hover:bg-white/20 disabled:bg-white/5";case"danger":return"bg-red-500/20 text-red-400 hover:bg-red-500/30 border border-red-500/30 disabled:bg-red-500/10";case"ghost":return"text-text-secondary hover:text-text-primary hover:bg-white/5 disabled:text-gray-500";default:return"bg-primary text-white hover:bg-primary/80 disabled:bg-primary/50"}},L=()=>{switch(p){case"sm":return"px-3 py-2 text-sm";case"md":return"px-4 py-2";case"lg":return"px-6 py-3 text-lg";default:return"px-4 py-2"}};return e.jsx("button",{onClick:c,disabled:t||N,className:`
        ${E()}
        ${L()}
        rounded-lg transition-all duration-200
        disabled:opacity-50 disabled:cursor-not-allowed
        focus:outline-none focus:ring-2 focus:ring-primary/50
        ${b}
      `,...D,children:N?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current"}),"載入中..."]}):i})},C=({value:i,onChange:c,placeholder:h="",type:p="text",disabled:t=!1,error:N=!1,className:b="",...D})=>e.jsx("input",{type:p,value:i,onChange:c,placeholder:h,disabled:t,className:`
        w-full p-3 sm:p-4
        bg-white/10 border rounded-lg
        text-white placeholder-gray-400
        focus:outline-none focus:ring-2 focus:ring-primary/50
        disabled:opacity-50 disabled:cursor-not-allowed
        ${N?"border-red-500/50 focus:ring-red-500/50":"border-white/20"}
        ${b}
      `,...D}),g=({children:i,htmlFor:c,className:h="",required:p=!1})=>e.jsx("label",{htmlFor:c,className:`
        block text-sm sm:text-base text-white mb-2
        ${p?'after:content-["*"] after:text-red-400 after:ml-1':""}
        ${h}
      `,children:i}),M=({children:i,level:c=1,className:h="",gradient:p=!1})=>{const t=()=>{switch(c){case 1:return"text-2xl sm:text-3xl lg:text-4xl";case 2:return"text-xl sm:text-2xl lg:text-3xl";case 3:return"text-lg sm:text-xl lg:text-2xl";case 4:return"text-base sm:text-lg lg:text-xl";case 5:return"text-sm sm:text-base lg:text-lg";case 6:return"text-xs sm:text-sm lg:text-base";default:return"text-xl sm:text-2xl lg:text-3xl"}},N=()=>p?"bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent":"text-white",b=`h${c}`;return e.jsx(b,{className:`font-bold ${t()} ${N()} ${h}`,children:i})},l=({children:i,size:c="base",color:h="white",className:p="",...t})=>{const N=()=>{switch(c){case"xs":return"text-xs";case"sm":return"text-sm";case"base":return"text-base";case"lg":return"text-lg";case"xl":return"text-xl";default:return"text-base"}},b=()=>{switch(h){case"white":return"text-white";case"secondary":return"text-text-secondary";case"primary":return"text-primary";case"danger":return"text-red-400";case"success":return"text-green-400";default:return"text-white"}};return e.jsx("p",{className:`${N()} ${b()} ${p}`,...t,children:i})},He=({customRules:i=[],scheduleTemplates:c=[],onRulesChange:h,onTemplatesChange:p,isSaving:t=!1,scheduleData:N=null,speechTexts:b=[],onSpeechTextsChange:D,showBubble:E=!1,onShowBubbleChange:L,intervalSeconds:H=4,onIntervalSecondsChange:V,smartMode:G=!1,onSmartModeChange:z})=>{const[Y,R]=m.useState(!1),[A,X]=m.useState(null),[k,K]=m.useState("custom"),[x,S]=m.useState({name:"",type:"timeRange",startTime:"08:00",endTime:"10:00",day:"一",month:1,date:1,messages:[""],enabled:!0}),[j,J]=m.useState(null),[v,ae]=m.useState({}),[$,Z]=m.useState(!1),[Q,u]=m.useState(!1);m.useEffect(()=>{N?J(N):(async()=>{try{Z(!0);const a=await te(U(P,"schedule","currentMonth")),r=await te(U(P,"schedule","nextMonth"));let d=null;a.exists()?d=a.data():r.exists()&&(d=r.data()),J(d)}catch(a){console.error("載入班表資料失敗:",a)}finally{Z(!1)}})()},[N]),m.useEffect(()=>{(async()=>{try{u(!0);const a=await Fe(Re(P,"names")),r={};a.forEach(d=>{const w=d.data();w.name&&(r[d.id]=w.name)}),ae(r)}catch(a){console.error("載入同事姓名資料失敗:",a)}finally{u(!1)}})()},[]);const y=s=>{if(!s||typeof s!="object")return[];const a=[],r=new Date,d=r.getFullYear(),w=r.getMonth()+1,T=r.getDate();for(const[n,q]of Object.entries(s))if(n!=="_lastUpdated"&&q&&typeof q=="object"){for(const[re,I]of Object.entries(q))if(I&&I.trim()&&I!=="休假"&&I!=="特休"&&I!=="月休"){const _=parseInt(re);_===T&&a.push({id:`${n}_${_}`,date:`${d}-${String(w).padStart(2,"0")}-${String(_).padStart(2,"0")}`,shift:I,employee:n})}}return a},[o,O]=m.useState({name:"",message:"",enabled:!0,timeRestriction:!1,startTime:"08:00",endTime:"10:00"}),[W,ie]=m.useState(null),[ee,de]=m.useState(""),ce=async()=>{if(ee.trim()&&D){const s=[...b,ee.trim()];try{await D(s),de("")}catch(a){console.error("添加對話失敗:",a)}}},xe=async s=>{if(D){const a=b.filter((r,d)=>d!==s);try{await D(a)}catch(r){console.error("刪除對話失敗:",r)}}},oe=()=>{O({name:"",message:"",enabled:!0,timeRestriction:!1,startTime:"08:00",endTime:"10:00"}),ie(null),R(!1)},B=(s,a)=>{O(r=>({...r,[s]:a}))},he=(s,a)=>{const r=new Date,d=r.getHours(),w=r.getMinutes(),T=d*60+w,[n,q]=s.split(":").map(Number),[re,I]=a.split(":").map(Number),_=n*60+q,ne=re*60+I;return ne<_?T>=_||T<=ne:T>=_&&T<=ne},me=()=>{S({name:"",type:"timeRange",startTime:"08:00",endTime:"10:00",day:"一",month:1,date:1,messages:[""],enabled:!0}),X(null),R(!1)},F=(s,a)=>{S(r=>({...r,[s]:a}))},ue=(s,a)=>{const r=[...x.messages];r[s]=a,S(d=>({...d,messages:r}))},be=()=>{S(s=>({...s,messages:[...s.messages,""]}))},ge=s=>{if(x.messages.length>1){const a=x.messages.filter((r,d)=>d!==s);S(r=>({...r,messages:a}))}},je=()=>{if(!x.name.trim()){alert("請填寫規則名稱");return}const s=x.messages.filter(d=>d&&typeof d=="string"&&d.trim()!=="");if(s.length===0){alert("請至少添加一個對話內容");return}const a={id:A?A.id:Date.now().toString(),...x,messages:s};if(!Se(a)){alert("規則設定有誤，請檢查時間格式");return}let r;A?r=i.map(d=>d.id===A.id?a:d):r=[...i,a],h(r),me()},pe=s=>{if(window.confirm("確定要刪除這個規則嗎？")){const a=i.filter(r=>r.id!==s);h(a)}},ye=s=>{const a=i.map(r=>r.id===s?{...r,enabled:!r.enabled}:r);h(a)},fe=s=>{S({name:s.name,type:s.type,startTime:s.startTime||"08:00",endTime:s.endTime||"10:00",day:s.day||"一",month:s.month||1,date:s.date||1,messages:s.messages||[""],enabled:s.enabled}),X(s),R(!0)},ve=()=>{window.confirm("確定要載入預設規則嗎？這會覆蓋現有的自定義規則。")&&h(Ee())},Ne=()=>{if(!o.name.trim()){alert("請填寫模板名稱");return}if(!o.message.trim()){alert("請填寫問候語內容");return}const s={id:W?W.id:Date.now().toString(),...o};if(!Le(s)){alert("模板設定有誤，請檢查內容");return}let a;W?a=c.map(r=>r.id===W.id?s:r):a=[...c,s],p(a),oe()},we=s=>{if(window.confirm("確定要刪除這個模板嗎？")){const a=c.filter(r=>r.id!==s);p(a)}},Te=s=>{const a=c.map(r=>r.id===s?{...r,enabled:!r.enabled}:r);p(a)},ke=s=>{O({name:s.name,message:s.message,enabled:s.enabled,timeRestriction:s.timeRestriction||!1,startTime:s.startTime||"08:00",endTime:s.endTime||"10:00"}),ie(s),R(!0)},Ce=()=>{const s=Ae();p(s)},Me=()=>{if($){alert("請稍候，正在載入班表資料...");return}if(Q){alert("請稍候，正在載入姓名資料...");return}if(!j){alert("無班表資料，無法預覽所有智能對話。");return}Object.keys(v).length===0&&alert("無姓名資料，將顯示職員編號。");const s=se(j,i,c,v),a=s.map((r,d)=>`${d+1}. [${r.source}] ${r.message}`).join(`

`);s.length===0?alert(`目前沒有觸發的智能對話。

只會播放您設定的普通對話。`):alert(`智能對話預覽 (共${s.length}條)：

${a}

注意：這些對話會與您設定的普通對話一起輪流播放。`)},De=()=>{switch(x.type){case"timeRange":return e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"startTime",required:!0,children:"開始時間"}),e.jsx(C,{id:"startTime",type:"time",value:x.startTime,onChange:s=>F("startTime",s.target.value),disabled:t})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"endTime",required:!0,children:"結束時間"}),e.jsx(C,{id:"endTime",type:"time",value:x.endTime,onChange:s=>F("endTime",s.target.value),disabled:t})]})]});case"dayOfWeek":return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"daySelect",required:!0,children:"星期幾"}),e.jsxs("select",{id:"daySelect",value:x.day,onChange:s=>F("day",s.target.value),disabled:t,className:"w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary/50 disabled:opacity-50",children:[e.jsx("option",{value:"一",children:"星期一"}),e.jsx("option",{value:"二",children:"星期二"}),e.jsx("option",{value:"三",children:"星期三"}),e.jsx("option",{value:"四",children:"星期四"}),e.jsx("option",{value:"五",children:"星期五"}),e.jsx("option",{value:"六",children:"星期六"}),e.jsx("option",{value:"日",children:"星期日"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"startTime",required:!0,children:"開始時間"}),e.jsx(C,{id:"startTime",type:"time",value:x.startTime,onChange:s=>F("startTime",s.target.value),disabled:t})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"endTime",required:!0,children:"結束時間"}),e.jsx(C,{id:"endTime",type:"time",value:x.endTime,onChange:s=>F("endTime",s.target.value),disabled:t})]})]})]});case"specificDate":return e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"month",required:!0,children:"月份"}),e.jsx(C,{id:"month",type:"number",min:"1",max:"12",value:x.month,onChange:s=>F("month",parseInt(s.target.value)),disabled:t})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"date",required:!0,children:"日期"}),e.jsx(C,{id:"date",type:"number",min:"1",max:"31",value:x.date,onChange:s=>F("date",parseInt(s.target.value)),disabled:t})]})]});default:return null}};return e.jsxs(Ue,{children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx(M,{level:2,gradient:!0,children:"智能對話規則管理"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:Me,variant:"secondary",size:"sm",disabled:t||$||Q,children:"預覽所有對話"}),e.jsx(f,{onClick:()=>R(!0),variant:"primary",size:"sm",disabled:t,children:"添加規則"})]})]}),e.jsxs("div",{className:"bg-orange-500/10 border border-orange-500/20 rounded-lg p-4 mb-6",children:[e.jsx(M,{level:3,className:"text-orange-400 mb-4",children:"基本設定"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"bubbleToggle",checked:E,disabled:t,onChange:s=>L&&L(s.target.checked),className:"w-5 h-5 disabled:opacity-50"}),e.jsx(g,{htmlFor:"bubbleToggle",className:"!mb-0",children:"顯示對話輪播"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"smartModeToggle",checked:G,disabled:t,onChange:()=>z&&z(!G),className:"w-5 h-5 disabled:opacity-50"}),e.jsx(g,{htmlFor:"smartModeToggle",className:"!mb-0",children:"智能模式（根據自定義規則和班表問候自動顯示對話）"})]}),e.jsxs("div",{children:[e.jsxs(g,{htmlFor:"intervalSlider",children:["輪播間隔 (",H,"秒)"]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"range",id:"intervalSlider",min:"1",max:"10",value:H,disabled:t,onChange:s=>V&&V(parseInt(s.target.value)),className:"flex-1 h-2 bg-white/10 rounded-lg appearance-none cursor-pointer slider disabled:opacity-50"}),e.jsxs("span",{className:"text-white min-w-[3rem] text-center",children:[H,"s"]})]}),e.jsxs("div",{className:"flex justify-between text-xs text-gray-400 mt-1",children:[e.jsx("span",{children:"1秒"}),e.jsx("span",{children:"10秒"})]})]})]})]}),e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 mb-6",children:[e.jsx(M,{level:3,className:"text-blue-400 mb-2",children:"班表資料狀態"}),e.jsx(l,{size:"sm",className:"text-blue-300",children:$?"載入班表中...":j?`已載入 ${Object.keys(j).filter(s=>s!=="_lastUpdated").length} 位同事的班表資料`:"未載入班表資料"}),j&&j._lastUpdated&&e.jsxs(l,{size:"sm",className:"text-blue-300 mt-1",children:["班表最後更新：",new Date(j._lastUpdated).toLocaleString()]}),e.jsx(l,{size:"sm",className:"text-blue-300 mt-1",children:Q?"載入姓名中...":Object.keys(v).length>0?`已載入 ${Object.keys(v).length} 位同事的姓名資料`:"未載入姓名資料"})]}),e.jsxs("div",{className:"flex border-b border-white/10 mb-6",children:[e.jsxs("button",{onClick:()=>K("custom"),className:`px-4 py-2 text-sm font-medium transition-colors ${k==="custom"?"text-primary border-b-2 border-primary":"text-text-secondary hover:text-text-primary"}`,children:["自定義規則 (",i.length,")"]}),e.jsxs("button",{onClick:()=>K("schedule"),className:`px-4 py-2 text-sm font-medium transition-colors ${k==="schedule"?"text-primary border-b-2 border-primary":"text-text-secondary hover:text-text-primary"}`,children:["班表問候模板 (",c.length,")"]}),e.jsxs("button",{onClick:()=>K("dialogue"),className:`px-4 py-2 text-sm font-medium transition-colors ${k==="dialogue"?"text-primary border-b-2 border-primary":"text-text-secondary hover:text-text-primary"}`,children:["對話管理 (",b.length,")"]})]}),k==="custom"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-purple-500/10 border border-purple-500/20 rounded-lg p-4 mb-6",children:[e.jsx(M,{level:3,className:"text-purple-400 mb-2",children:"自定義規則說明"}),e.jsx(l,{size:"sm",className:"text-purple-300",children:"可以設定特定時間範圍、星期幾或特定日期的對話規則，系統會根據條件自動顯示對話。"})]}),Y&&e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded-lg p-4 mb-6",children:[e.jsx(M,{level:3,className:"mb-4",children:A?"編輯規則":"添加新規則"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"ruleName",required:!0,children:"規則名稱"}),e.jsx(C,{id:"ruleName",value:x.name,onChange:s=>F("name",s.target.value),placeholder:"例如：早上問候",disabled:t})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"ruleType",required:!0,children:"規則類型"}),e.jsxs("select",{id:"ruleType",value:x.type,onChange:s=>F("type",s.target.value),disabled:t,className:"w-full p-3 bg-white/10 border border-white/20 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-primary/50 disabled:opacity-50",children:[e.jsx("option",{value:"timeRange",children:"時間範圍"}),e.jsx("option",{value:"dayOfWeek",children:"星期幾"}),e.jsx("option",{value:"specificDate",children:"特定日期"})]})]}),De(),e.jsxs("div",{children:[e.jsxs(g,{required:!0,children:["對話內容 (",x.messages.length,"條)"]}),e.jsxs("div",{className:"space-y-2",children:[x.messages.map((s,a)=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{value:s,onChange:r=>ue(a,r.target.value),placeholder:`對話 ${a+1}...`,disabled:t}),e.jsx(f,{onClick:()=>ge(a),variant:"danger",size:"sm",disabled:t||x.messages.length<=1,className:"px-3",children:"刪除"})]},a)),e.jsx(f,{onClick:be,variant:"secondary",size:"sm",disabled:t,className:"w-full",children:"添加對話"})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"ruleEnabled",checked:x.enabled,onChange:s=>F("enabled",s.target.checked),disabled:t,className:"w-5 h-5 disabled:opacity-50"}),e.jsx(g,{htmlFor:"ruleEnabled",className:"!mb-0",children:"啟用此規則"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:je,variant:"primary",disabled:t,loading:t,children:A?"更新規則":"添加規則"}),e.jsx(f,{onClick:me,variant:"secondary",disabled:t,children:"取消"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(g,{children:["現有規則 (",i.length,"條)"]}),e.jsx(f,{onClick:ve,variant:"secondary",size:"sm",disabled:t,children:"載入預設"})]}),i.length===0?e.jsx(l,{color:"secondary",className:"text-center py-8",children:"暫無自定義規則"}):i.map(s=>{var a,r;return e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:s.enabled,onChange:()=>ye(s.id),disabled:t,className:"w-4 h-4 disabled:opacity-50"}),e.jsx(M,{level:4,className:"!mb-0",children:s.name}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${s.enabled?"bg-green-500/20 text-green-400":"bg-gray-500/20 text-gray-400"}`,children:s.enabled?"啟用":"停用"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:()=>fe(s),variant:"ghost",size:"sm",disabled:t,children:"編輯"}),e.jsx(f,{onClick:()=>pe(s.id),variant:"danger",size:"sm",disabled:t,children:"刪除"})]})]}),e.jsxs(l,{size:"sm",color:"secondary",className:"mb-2",children:["類型：",s.type==="timeRange"?"時間範圍":s.type==="dayOfWeek"?"星期幾":"特定日期"]}),s.type==="timeRange"&&e.jsxs(l,{size:"sm",color:"secondary",className:"mb-2",children:["時間：",s.startTime," - ",s.endTime]}),s.type==="dayOfWeek"&&e.jsxs(l,{size:"sm",color:"secondary",className:"mb-2",children:["星期",s.day," ",s.startTime," - ",s.endTime]}),s.type==="specificDate"&&e.jsxs(l,{size:"sm",color:"secondary",className:"mb-2",children:[s.month,"月",s.date,"日"]}),e.jsxs(l,{size:"sm",color:"secondary",className:"mb-2",children:["對話數量：",((a=s.messages)==null?void 0:a.length)||0," 條"]}),e.jsx("div",{className:"space-y-1",children:(r=s.messages)==null?void 0:r.map((d,w)=>e.jsx(l,{className:"bg-white/5 rounded p-2 text-sm",children:d},w))})]},s.id)})]})]}),k==="schedule"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 mb-6",children:[e.jsx(M,{level:3,className:"text-blue-400 mb-2",children:"可用變數說明"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-2 text-sm",children:[e.jsxs("div",{children:[e.jsx(l,{size:"sm",className:"text-blue-300 font-bold",children:"班次變數："}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{早班同事}"," - 早班同事名字"]}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{中班同事}"," - 中班同事名字"]}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{晚班同事}"," - 晚班同事名字"]}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{所有同事}"," - 所有上班同事名字"]})]}),e.jsxs("div",{children:[e.jsx(l,{size:"sm",className:"text-blue-300 font-bold",children:"人數變數："}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{早班人數}"," - 早班人數"]}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{中班人數}"," - 中班人數"]}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{晚班人數}"," - 晚班人數"]}),e.jsxs(l,{size:"sm",className:"text-blue-300",children:["• ","{總人數}"," - 總上班人數"]})]})]})]}),Y&&e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded-lg p-4 mb-6",children:[e.jsx(M,{level:3,className:"mb-4",children:W?"編輯模板":"添加新模板"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"templateName",required:!0,children:"模板名稱"}),e.jsx(C,{id:"templateName",value:o.name,onChange:s=>B("name",s.target.value),placeholder:"例如：早班問候",disabled:t})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"templateMessage",required:!0,children:"問候語內容"}),e.jsx(C,{id:"templateMessage",value:o.message,onChange:s=>B("message",s.target.value),placeholder:"例如：{早班同事}，早安！今天也要加油喔！",disabled:t})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"templateEnabled",checked:o.enabled,onChange:s=>B("enabled",s.target.checked),disabled:t,className:"w-5 h-5 disabled:opacity-50"}),e.jsx(g,{htmlFor:"templateEnabled",className:"!mb-0",children:"啟用此模板"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",id:"timeRestriction",checked:o.timeRestriction,onChange:s=>B("timeRestriction",s.target.checked),disabled:t,className:"w-5 h-5 disabled:opacity-50"}),e.jsx(g,{htmlFor:"timeRestriction",className:"!mb-0",children:"啟用時間限制"})]}),o.timeRestriction&&e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(g,{htmlFor:"startTime",required:!0,children:"限制開始時間"}),e.jsx(C,{id:"startTime",type:"time",value:o.startTime,onChange:s=>B("startTime",s.target.value),disabled:t})]}),e.jsxs("div",{children:[e.jsx(g,{htmlFor:"endTime",required:!0,children:"限制結束時間"}),e.jsx(C,{id:"endTime",type:"time",value:o.endTime,onChange:s=>B("endTime",s.target.value),disabled:t})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:Ne,variant:"primary",disabled:t,loading:t,children:W?"更新模板":"添加模板"}),e.jsx(f,{onClick:oe,variant:"secondary",disabled:t,children:"取消"})]})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(g,{children:["現有模板 (",c.length,"條)"]}),e.jsx(f,{onClick:Ce,variant:"secondary",size:"sm",disabled:t,children:"載入預設"})]}),c.length===0?e.jsx(l,{color:"secondary",className:"text-center py-8",children:"暫無班表問候模板"}):c.map(s=>e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("input",{type:"checkbox",checked:s.enabled,onChange:()=>Te(s.id),disabled:t,className:"w-4 h-4 disabled:opacity-50"}),e.jsx(M,{level:4,className:"!mb-0",children:s.name}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${s.enabled?"bg-green-500/20 text-green-400":"bg-gray-500/20 text-gray-400"}`,children:s.enabled?"啟用":"停用"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:()=>ke(s),variant:"ghost",size:"sm",disabled:t,children:"編輯"}),e.jsx(f,{onClick:()=>we(s.id),variant:"danger",size:"sm",disabled:t,children:"刪除"})]})]}),e.jsxs(l,{size:"sm",color:"secondary",className:"mb-2",children:["原始模板：",s.message]}),s.timeRestriction&&e.jsxs(l,{size:"sm",color:"secondary",className:"mb-2",children:["時間限制：",s.startTime," - ",s.endTime]})]},s.id))]})]}),k==="dialogue"&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"space-y-4 mb-6",children:[e.jsx(g,{htmlFor:"newMessage",children:"添加新對話"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(C,{id:"newMessage",type:"text",value:ee,onChange:s=>de(s.target.value),disabled:t,placeholder:"輸入新對話內容...",onKeyPress:s=>s.key==="Enter"&&!t&&ce()}),e.jsx(f,{onClick:()=>ce(),disabled:t||!ee.trim(),loading:t,children:t?"添加中...":"添加"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(g,{children:["對話列表 (",b.length,"條)"]}),e.jsx("div",{className:"max-h-64 overflow-y-auto space-y-2 border border-white/10 rounded-lg p-3",children:b.length===0?e.jsx(l,{color:"secondary",className:"text-center py-4",children:"暫無對話內容"}):b.map((s,a)=>e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-white/5 rounded-lg",children:[e.jsx(l,{className:"flex-1",children:s}),e.jsx(f,{onClick:()=>xe(a),variant:"ghost",size:"sm",disabled:t,className:"p-1 text-red-400 hover:text-red-300",title:"刪除",children:e.jsx("svg",{className:"w-4 h-4",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})})]},a))})]})]}),e.jsxs("div",{className:"mt-8 bg-gradient-to-r from-purple-500/10 to-blue-500/10 border border-purple-500/20 rounded-lg p-6",children:[e.jsx(M,{level:3,className:"text-purple-400 mb-4 text-center",children:"所有對話列表"}),e.jsx("div",{className:"space-y-3",children:(()=>{const s=se(j,i,c,v),a=s.map(n=>n.message).filter(n=>n&&typeof n=="string"&&n.trim()!==""),r=b.filter(n=>n&&typeof n=="string"&&n.trim()!==""&&!a.includes(n)),d=[...s.map(n=>({...n,isNormal:!1})),...r.map(n=>({type:"normal",priority:999,message:n,source:"普通對話",isNormal:!0}))],w=[],T=new Set;for(const n of d)T.has(n.message)||(w.push(n),T.add(n.message));return w.length===0?e.jsx(l,{size:"sm",className:"text-gray-400 text-center py-4",children:"目前沒有任何對話"}):w.map((n,q)=>e.jsxs("div",{className:"bg-white/5 border border-white/10 rounded-lg p-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs(l,{size:"sm",className:"text-green-400 font-bold",children:[q+1,". ",n.source]}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${n.type==="custom"?"bg-purple-500/20 text-purple-400":n.type==="schedule"?"bg-blue-500/20 text-blue-400":n.type==="normal"?"bg-orange-500/20 text-orange-400":"bg-gray-500/20 text-gray-400"}`,children:n.type==="custom"?"自定義規則":n.type==="schedule"?"班表模板":n.type==="normal"?"普通對話":"其他"})]}),e.jsx(l,{className:"text-white",children:n.message})]},q))})()}),e.jsxs("div",{className:"mt-4 pt-4 border-t border-white/10",children:[e.jsx(l,{size:"sm",className:"text-blue-300 font-bold mb-2",children:"詳細調試資訊："}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-xs text-gray-400",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:["班表資料：",j?"已載入":"未載入"]}),e.jsxs("div",{children:["姓名資料：",Object.keys(v).length>0?`已載入 ${Object.keys(v).length} 個`:"未載入"]}),e.jsxs("div",{children:["今天上班同事：",j?y(j).length:0," 人"]}),e.jsxs("div",{children:["自定義規則：",i.filter(s=>s.enabled).length," 個啟用"]}),e.jsxs("div",{children:["班表模板：",c.filter(s=>s.enabled).length," 個啟用"]})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{children:["智能對話：",se(j,i,c,v).length," 條"]}),e.jsxs("div",{children:["普通對話：",b.length," 條"]}),e.jsxs("div",{children:["總對話數：",se(j,i,c,v).length+b.length," 條"]}),e.jsxs("div",{children:["當前時間：",new Date().toLocaleString()]}),e.jsxs("div",{children:["星期：",new Date().toLocaleDateString("zh-TW",{weekday:"long"})]})]})]}),c.filter(s=>s.enabled).length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-white/10",children:[e.jsx(l,{size:"sm",className:"text-blue-300 font-bold mb-2",children:"班表模板調試："}),e.jsx("div",{className:"space-y-1 text-xs text-gray-400",children:c.filter(s=>s.enabled).map((s,a)=>{const r=y(j),d=ze(r,v),w=s.timeRestriction?he(s.startTime,s.endTime):!0,T=$e(s,j,v),n=T&&typeof T=="string"&&T.trim()!=="";return e.jsxs("div",{className:"bg-white/5 rounded p-2",children:[e.jsxs("div",{children:["模板：",s.name]}),e.jsxs("div",{children:["時間限制：",s.timeRestriction?`${s.startTime}-${s.endTime}`:"無"]}),e.jsxs("div",{children:["時間檢查：",w?"通過":"不通過"]}),e.jsxs("div",{children:["會顯示：",n?"是":"否"]}),n&&e.jsxs("div",{children:["處理後：",T]}),e.jsxs("div",{children:["早班同事：",d.morning.join("、")||"無"]}),e.jsxs("div",{children:["中班同事：",d.afternoon.join("、")||"無"]}),e.jsxs("div",{children:["晚班同事：",d.evening.join("、")||"無"]})]},a)})})]})]})]})]})},Ge=()=>{const[i,c]=m.useState(!1),[h,p]=m.useState([]),[t,N]=m.useState(4),[b,D]=m.useState(!1),[E,L]=m.useState(!0),[H,V]=m.useState(!1),[G,z]=m.useState(""),[Y,R]=m.useState(""),[A,X]=m.useState(null),[k,K]=m.useState(!1),[x,S]=m.useState([]),[j,J]=m.useState([]),v=qe();m.useEffect(()=>le.onAuthStateChanged(async y=>{if(y)try{const o=await Ie(y.uid);D(o),o||(z("您沒有管理員權限"),setTimeout(()=>v("/"),3e3))}catch(o){z("檢查權限時發生錯誤"),console.error("權限檢查失敗:",o)}else D(!1),z("請先登入"),setTimeout(()=>v("/"),2e3);L(!1)}),[v]),m.useEffect(()=>{b&&(async()=>{try{console.log("AdminPanel: 開始載入班表資料...");const y=await te(U(P,"schedule","currentMonth")),o=await te(U(P,"schedule","nextMonth"));console.log("AdminPanel: currentMonthDoc.exists():",y.exists()),console.log("AdminPanel: nextMonthDoc.exists():",o.exists());let O=null;y.exists()?O=y.data():o.exists()&&(O=o.data()),X(O)}catch{}})()},[b]),m.useEffect(()=>b?Oe(U(P,"catSpeech","global"),y=>{if(y.exists()){const o=y.data();c(o.enabled||!1),p(o.texts||[]),N(o.intervalSeconds||4),K(o.smartMode||!1),S(o.customRules||[]),J(o.scheduleTemplates||[])}},y=>{console.error("監聽設定失敗:",y),z("載入設定失敗")}):void 0,[b]);const ae=async()=>{try{L(!0);const{signOut:u}=await _e(async()=>{const{signOut:y}=await import("./index-CwwGDm5I.js").then(o=>o.w);return{signOut:y}},__vite__mapDeps([0,1]));await u(le),v("/")}catch(u){console.error("登出失敗:",u),z("登出失敗"),L(!1)}},$=async u=>{var y;if(b)try{V(!0),z(""),R(""),await Pe(U(P,"catSpeech","global"),{...u,lastUpdated:We(),updatedBy:(y=le.currentUser)==null?void 0:y.uid}),R("設定已更新"),setTimeout(()=>R(""),3e3)}catch(o){console.error("更新設定失敗:",o),z("更新設定失敗")}finally{V(!1)}},Z=async u=>{S(u),await $({texts:h,enabled:i,intervalSeconds:t,smartMode:k,customRules:u,scheduleTemplates:j})},Q=async u=>{J(u),await $({texts:h,enabled:i,intervalSeconds:t,smartMode:k,customRules:x,scheduleTemplates:u})};return E?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),e.jsx(l,{size:"lg",className:"mb-2",children:"載入中..."}),e.jsx(l,{size:"sm",color:"secondary",children:"正在檢查管理員權限"})]})}):G?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center max-w-md mx-auto",children:[e.jsx("div",{className:"text-red-400 text-4xl mb-4",children:"⚠️"}),e.jsx(M,{level:2,className:"mb-4",children:"發生錯誤"}),e.jsx(l,{className:"mb-6",children:G}),e.jsxs("div",{className:"space-y-3",children:[e.jsx(f,{onClick:()=>v("/"),variant:"primary",size:"lg",className:"w-full",children:"返回首頁"}),e.jsx(f,{onClick:()=>window.location.reload(),variant:"secondary",size:"lg",className:"w-full",children:"重新載入"})]})]})}):b?e.jsx("div",{className:"min-h-screen bg-background",children:e.jsxs(Be,{children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx(M,{level:1,gradient:!0,className:"mb-2",children:"管理員設定"}),e.jsx(l,{color:"secondary",children:"管理貓咪對話和系統設定"})]}),Y&&e.jsx("div",{className:"mb-6 bg-green-500/10 border border-green-500/30 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-green-400",children:"✓"}),e.jsx(l,{color:"success",children:Y})]})}),e.jsx("div",{className:"flex justify-end mb-6",children:e.jsx(f,{onClick:ae,variant:"danger",disabled:E,loading:E,children:E?"登出中...":"登出管理員"})}),e.jsx(He,{customRules:x,scheduleTemplates:j,onRulesChange:Z,onTemplatesChange:Q,isSaving:H,scheduleData:A,speechTexts:h,onSpeechTextsChange:u=>$({texts:u,enabled:i,intervalSeconds:t,smartMode:k,customRules:x,scheduleTemplates:j}),showBubble:i,onShowBubbleChange:u=>$({texts:h,enabled:u,intervalSeconds:t,smartMode:k,customRules:x,scheduleTemplates:j}),intervalSeconds:t,onIntervalSecondsChange:u=>$({texts:h,enabled:i,intervalSeconds:u,smartMode:k,customRules:x,scheduleTemplates:j}),smartMode:k,onSmartModeChange:u=>$({texts:h,enabled:i,intervalSeconds:t,smartMode:u,customRules:x,scheduleTemplates:j})})]})}):null};export{Ge as default};
