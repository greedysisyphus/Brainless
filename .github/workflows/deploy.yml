name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'data/**'  # 忽略 data 目錄的變更，避免資料更新時觸發部署
  workflow_dispatch:  # 允許手動觸發部署

permissions:
  contents: write
  pages: write
  id-token: write

# 添加並發控制，確保只有最新的部署會運行
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  # 檢查是否應該跳過部署
  check-skip:
    runs-on: ubuntu-latest
    outputs:
      should-skip: ${{ steps.skip.outputs.should_skip }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2  # 需要前一個提交來比較變更
      - name: Check if should skip deployment
        id: skip
        run: |
          # 方法1: 檢查提交訊息
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"
          # 只跳過包含 [skip ci] 或 [skip workflow] 的提交
          # 注意：不跳過 "Update flight data (實質變化)" 的提交，因為這應該觸發部署
          if [[ "$COMMIT_MSG" == *"[skip ci]"* ]] || [[ "$COMMIT_MSG" == *"[skip workflow]"* ]]; then
            echo "should_skip=true" >> $GITHUB_OUTPUT
            echo "Skipping deployment: commit message contains skip marker"
            exit 0
          fi
          
          # 方法2: 檢查變更的文件（如果只有 data/ 目錄變更，跳過）
          # 對於手動觸發（workflow_dispatch），跳過文件檢查
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "Proceeding with deployment: manual trigger"
            exit 0
          fi
          
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          # 如果無法比較（例如第一次提交），繼續部署
          if [ -z "$CHANGED_FILES" ]; then
            echo "should_skip=false" >> $GITHUB_OUTPUT
            echo "Proceeding with deployment: no previous commit to compare"
            exit 0
          fi
          
          # 檢查是否只有 data/ 目錄的變更
          NON_DATA_FILES=$(echo "$CHANGED_FILES" | grep -v "^data/" | grep -v "^\.github/workflows/update-flight-data.yml" || true)
          
          # 如果只有 data/ 目錄變更，但提交訊息包含 "實質變化"，則不跳過（需要部署）
          if [ -z "$NON_DATA_FILES" ] && [ -n "$CHANGED_FILES" ]; then
            if [[ "$COMMIT_MSG" == *"實質變化"* ]]; then
              echo "should_skip=false" >> $GITHUB_OUTPUT
              echo "Proceeding with deployment: data files changed with substantial updates"
              exit 0
            else
              echo "should_skip=true" >> $GITHUB_OUTPUT
              echo "Skipping deployment: only data files changed (no substantial updates)"
              exit 0
            fi
          fi
          
          # 如果通過所有檢查，繼續部署
          echo "should_skip=false" >> $GITHUB_OUTPUT
          echo "Proceeding with deployment"

  build-and-deploy:
    needs: check-skip
    if: needs.check-skip.outputs.should-skip != 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - uses: actions/checkout@v4
        with:
          # 確保拉取最新的提交，包括資料文件的更新
          fetch-depth: 0
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Build
        run: npm run build
        env:
          NODE_ENV: production
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
      
      - name: Copy data files to build output
        run: |
          mkdir -p docs/data
          # 確保複製所有資料文件，包括最新創建的
          echo "Checking data directory:"
          ls -la data/ | head -10 || echo "data/ directory not found"
          
          if [ -d "data" ] && [ "$(ls -A data/*.json 2>/dev/null)" ]; then
            echo "Copying data files..."
            cp -v data/*.json docs/data/
            echo "✅ Data files copied successfully:"
            ls -lh docs/data/*.json | tail -10
            echo "Total files: $(ls -1 docs/data/*.json 2>/dev/null | wc -l)"
            
            # 特別檢查今天的文件是否存在
            TODAY=$(date +%Y-%m-%d)
            if [ -f "docs/data/flight-data-${TODAY}.json" ]; then
              echo "✅ Today's data file exists: flight-data-${TODAY}.json"
            else
              echo "⚠️  Warning: Today's data file not found: flight-data-${TODAY}.json"
            fi
          else
            echo "⚠️  Warning: No JSON files found in data/ directory"
            echo "Data directory contents:"
            ls -la data/ || echo "data/ directory does not exist"
          fi
          
      - name: Check build output
        run: |
          echo "Build output contents:"
          ls -la docs/
          echo "Data directory:"
          ls -la docs/data/ || echo "No data directory"
          
          # 檢查關鍵文件是否存在
          if [ ! -f docs/index.html ]; then
            echo "ERROR: docs/index.html is missing!"
            exit 1
          fi
          
          if [ ! -d docs/assets ]; then
            echo "ERROR: docs/assets directory is missing!"
            exit 1
          fi
          
          if [ -z "$(ls -A docs/assets 2>/dev/null)" ]; then
            echo "ERROR: docs/assets directory is empty!"
            exit 1
          fi
          
          echo "✓ All critical files exist"
          echo "Index.html content:"
          head -10 docs/index.html
          
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./docs
          
      - name: Create deployment log
        run: |
          mkdir -p docs/data
          
          # 檢查最近的提交是否包含資料更新
          COMMIT_MSG=$(git log -1 --pretty=%B)
          HAS_DATA_UPDATE=false
          
          if [[ "$COMMIT_MSG" == *"Update flight data (實質變化)"* ]]; then
            HAS_DATA_UPDATE=true
          fi
          
          # 檢查是否有 data/ 目錄的文件變更
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          if echo "$CHANGED_FILES" | grep -q "^data/"; then
            HAS_DATA_UPDATE=true
          fi
          
          # 使用 Python 處理 JSON（改用臨時文件避免 heredoc 問題）
          python3 -c "
          import json
          import os
          from datetime import datetime
          
          DEPLOYMENT_LOG_FILE = 'docs/data/deployment-log.json'
          COMMIT_MSG = '''$COMMIT_MSG'''
          HAS_DATA_UPDATE = '''$HAS_DATA_UPDATE'''.lower() == 'true'
          
          # 讀取現有的部署記錄
          if os.path.exists(DEPLOYMENT_LOG_FILE):
              with open(DEPLOYMENT_LOG_FILE, 'r', encoding='utf-8') as f:
                  data = json.load(f)
                  deployments = data.get('deployments', [])
          else:
              deployments = []
          
          # 添加新的部署記錄
          new_deployment = {
              'timestamp': datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%SZ'),
              'hasDataUpdate': HAS_DATA_UPDATE,
              'commitMessage': COMMIT_MSG
          }
          
          # 合併並只保留最近 50 次部署
          deployments.append(new_deployment)
          deployments.sort(key=lambda x: x['timestamp'], reverse=True)
          deployments = deployments[:50]
          
          # 寫入文件
          with open(DEPLOYMENT_LOG_FILE, 'w', encoding='utf-8') as f:
              json.dump({'deployments': deployments}, f, ensure_ascii=False, indent=2)
          
          print(f'✅ Deployment log created:')
          print(f'   - Timestamp: {new_deployment[\"timestamp\"]}')
          print(f'   - Has data update: {HAS_DATA_UPDATE}')
          print(f'   - Total deployments logged: {len(deployments)}')
          "
        continue-on-error: true
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4 